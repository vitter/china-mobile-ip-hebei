# æ²³åŒ—çœä¸­å›½ç§»åŠ¨ IP æ®µæ‰«æå™¨

åŸºäº ip2region v3.x å’Œ RIPEstat API çš„è‡ªåŠ¨åŒ– IP æ®µè¯†åˆ«å·¥å…·ï¼Œç”¨äºæå–ç‰¹å®šçœä»½è¿è¥å•†çš„ CIDR åˆ—è¡¨ã€‚

## é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®é€šè¿‡ä»¥ä¸‹æµç¨‹è‡ªåŠ¨è¯†åˆ«æ²³åŒ—çœä¸­å›½ç§»åŠ¨çš„ IP æ®µï¼š

1. **è·å– ASN åˆ—è¡¨**ï¼šä» `data/cmcc.txt` è¯»å–ä¸­å›½ç§»åŠ¨çš„ ASNï¼ˆè‡ªæ²»ç³»ç»Ÿå·ï¼‰
2. **è·å– IP å‰ç¼€**ï¼šé€šè¿‡ RIPEstat API å¹¶å‘æŸ¥è¯¢æ¯ä¸ª ASN å¯¹åº”çš„ IPv4 CIDR å‰ç¼€
3. **æ™ºèƒ½é‡‡æ ·åˆ†æ**ï¼šå¯¹æ¯ä¸ª CIDR éšæœºé‡‡æ ·å¤šä¸ª IP åœ°å€
4. **ç¦»çº¿åœ°ç†å®šä½**ï¼šä½¿ç”¨ ip2region xdb æ•°æ®åº“è¿›è¡Œé«˜é€Ÿç¦»çº¿æŸ¥è¯¢ï¼ˆ~10Î¼s/æ¬¡ï¼‰
5. **ç½®ä¿¡åº¦åˆ†å±‚**ï¼šæ ¹æ®é‡‡æ ·å‘½ä¸­ç‡åˆ†ä¸º high/medium/none ä¸‰ä¸ªç­‰çº§
6. **ç»“æœè¾“å‡º**ï¼šç”Ÿæˆ txt/csv/json ä¸‰ç§æ ¼å¼çš„ç»“æœæ–‡ä»¶

## æ ¸å¿ƒç‰¹æ€§

- âœ… **å®Œå…¨ç¦»çº¿æŸ¥è¯¢**ï¼šip2region æœ¬åœ°æ•°æ®åº“ï¼Œæ— éœ€åœ¨çº¿ API
- âœ… **é«˜æ€§èƒ½å¹¶å‘**ï¼šasyncio + aiohttp å¼‚æ­¥è·å– ASN å‰ç¼€
- âœ… **æ™ºèƒ½é‡‡æ ·**ï¼šå¤šç‚¹éšæœºé‡‡æ ·æå‡å¤§ç½‘æ®µè¯†åˆ«å‡†ç¡®ç‡
- âœ… **ç»“æœåˆ†å±‚**ï¼šhighï¼ˆå…¨éƒ¨å‘½ä¸­ï¼‰/ mediumï¼ˆéƒ¨åˆ†å‘½ä¸­ï¼‰/ noneï¼ˆæœªå‘½ä¸­ï¼‰
- âœ… **è‡ªåŠ¨ç¼“å­˜**ï¼šAPI æŸ¥è¯¢ç»“æœæœ¬åœ°ç¼“å­˜ï¼Œå‡å°‘é‡å¤è¯·æ±‚
- âœ… **çµæ´»é…ç½®**ï¼šæ”¯æŒè‡ªå®šä¹‰é‡‡æ ·æ•°ã€å¹¶å‘æ•°ã€ASN åˆ—è¡¨

## é¡¹ç›®ç»“æ„

```
china-mobile-ip-hebei/
â”œâ”€â”€ data/                       # æ•°æ®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ cmcc.txt               # ä¸­å›½ç§»åŠ¨ ASN åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰
â”‚   â”œâ”€â”€ ip2region_v4.xdb       # ip2region æ•°æ®åº“ï¼ˆè‡ªåŠ¨ä¸‹è½½ï¼‰
â”‚   â””â”€â”€ prefixes_cache.json    # API æŸ¥è¯¢ç¼“å­˜
â”œâ”€â”€ output/                     # è¾“å‡ºç»“æœç›®å½•
â”‚   â”œâ”€â”€ hebei_cmcc_cidr.txt    # æ²³åŒ—ç§»åŠ¨ CIDR åˆ—è¡¨ï¼ˆçº¯æ–‡æœ¬ï¼‰
â”‚   â”œâ”€â”€ hebei_cmcc_cidr.csv    # è¯¦ç»†åˆ†æç»“æœï¼ˆCSV æ ¼å¼ï¼‰
â”‚   â””â”€â”€ hebei_cmcc_cidr.json   # å®Œæ•´æ•°æ®ï¼ˆJSON æ ¼å¼ï¼‰
â”œâ”€â”€ src/                        # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ ip2region/             # ip2region Python binding
â”‚   â”œâ”€â”€ main.py                # ä¸»ç¨‹åºå…¥å£
â”‚   â”œâ”€â”€ ip2region_client.py    # IP æŸ¥è¯¢å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ fetch_prefixes_async.py # ASN å‰ç¼€è·å–ï¼ˆRIPEstat APIï¼‰
â”‚   â”œâ”€â”€ scanner_advanced.py    # CIDR æ‰«æå™¨
â”‚   â””â”€â”€ ...                    # å…¶ä»–å·¥å…·æ¨¡å—
â”œâ”€â”€ requirements.txt           # Python ä¾èµ–
â””â”€â”€ README.md                  # æœ¬æ–‡æ¡£
```

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/yourusername/china-mobile-ip-hebei.git
cd china-mobile-ip-hebei

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆæ¨èï¼‰
python3 -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### 2. è¿è¡Œæ‰«æ

```bash
# åŸºç¡€è¿è¡Œï¼ˆä½¿ç”¨é»˜è®¤å‚æ•°ï¼‰
python3 src/main.py

# è‡ªå®šä¹‰å‚æ•°è¿è¡Œ
python3 src/main.py \
  --cmcc data/cmcc.txt \      # ASN åˆ—è¡¨æ–‡ä»¶
  --sample 3 \                # æ¯ä¸ª CIDR é‡‡æ · 3 ä¸ª IP
  --scan-workers 24 \         # æ‰«æçº¿ç¨‹æ•°
  --fetch-concurrency 20 \    # API å¹¶å‘æ•°
  --use-cache                 # ä½¿ç”¨æœ¬åœ°ç¼“å­˜
```

### 3. æŸ¥çœ‹ç»“æœ

```bash
# æŸ¥çœ‹åˆå¹¶åçš„ CIDR åˆ—è¡¨ï¼ˆæ¨èï¼Œç²¾ç®€ç‰ˆï¼‰
cat output/hebei_cmcc_cidr_merged.txt

# æŸ¥çœ‹åŸå§‹ CIDR åˆ—è¡¨ï¼ˆå®Œæ•´ç‰ˆï¼‰
cat output/hebei_cmcc_cidr.txt

# æŸ¥çœ‹åˆå¹¶åˆ†ææŠ¥å‘Š
python3 src/analyze_merge.py

# æŸ¥çœ‹è¯¦ç»† CSV
head output/hebei_cmcc_cidr.csv

# æŸ¥çœ‹å®Œæ•´ JSON
python3 -m json.tool output/hebei_cmcc_cidr.json | less
```

## å‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--cmcc` | `data/cmcc.txt` | ä¸­å›½ç§»åŠ¨ ASN åˆ—è¡¨æ–‡ä»¶è·¯å¾„ |
| `--sample` | `3` | æ¯ä¸ª CIDR éšæœºé‡‡æ ·çš„ IP æ•°é‡ |
| `--scan-workers` | `24` | æ‰«æçº¿ç¨‹æ± å¤§å° |
| `--fetch-concurrency` | `20` | API å¹¶å‘è¯·æ±‚æ•° |
| `--use-cache` | `False` | æ˜¯å¦ä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼ˆåŠ  --use-cache å¯ç”¨ï¼‰ |
| `--no-merge` | `False` | ç¦ç”¨ CIDR è‡ªåŠ¨åˆå¹¶ï¼ˆåŠ  --no-merge ç¦ç”¨ï¼‰ |

## è¾“å‡ºæ–‡ä»¶æ ¼å¼

### 1. hebei_cmcc_cidr.txtï¼ˆåŸå§‹ç‰ˆï¼‰
çº¯æ–‡æœ¬æ ¼å¼ï¼Œæ¯è¡Œä¸€ä¸ª CIDRï¼ŒåŒ…å« high å’Œ medium ç­‰çº§çš„ç»“æœï¼š
```
111.11.0.0/24
111.11.1.0/24
111.11.2.0/24
...
```
ğŸ“ **ç‰¹ç‚¹**ï¼šä¿ç•™æ‰€æœ‰åŸå§‹æ‰«æç»“æœï¼Œé€‚åˆè¯¦ç»†åˆ†æ

### 1.1 hebei_cmcc_cidr_merged.txtï¼ˆåˆå¹¶ç‰ˆï¼‰â­ æ¨è
ç»è¿‡æ™ºèƒ½åˆå¹¶çš„ç²¾ç®€ç‰ˆï¼Œå°†è¿ç»­åœ°å€æ®µåˆå¹¶æˆæ›´å¤§ç½‘æ®µï¼š
```
111.11.0.0/17
183.196.0.0/14
...
```
ğŸ“ **ç‰¹ç‚¹**ï¼š
- è‡ªåŠ¨åˆå¹¶è¿ç»­çš„å°ç½‘æ®µï¼ˆå¦‚å¤šä¸ª /24 åˆå¹¶ä¸º /21ï¼‰
- å¤§å¹…å‡å°‘è¡Œæ•°ï¼ˆé€šå¸¸å‡å°‘ 90%+ï¼‰
- ä¿æŒç›¸åŒçš„IPè¦†ç›–èŒƒå›´
- æ›´æ˜“é˜…è¯»å’Œä½¿ç”¨

### 2. hebei_cmcc_cidr.csv
CSV æ ¼å¼ï¼ŒåŒ…å«è¯¦ç»†åˆ†æä¿¡æ¯ï¼š
```csv
cidr,status,hits,samples,sampled_ips
111.11.0.0/17,high,3,3,111.11.0.1|111.11.32.128|111.11.64.200
111.11.0.0/24,high,3,3,111.11.0.50|111.11.0.150|111.11.0.250
...
```

### 3. hebei_cmcc_cidr.json
JSON æ ¼å¼ï¼Œå®Œæ•´æ•°æ®ç»“æ„ï¼š
```json
[
  {
    "cidr": "111.11.0.0/17",
    "status": "high",
    "hits": 3,
    "samples": 3,
    "sampled": ["111.11.0.1", "111.11.32.128", "111.11.64.200"]
  },
  ...
]
```

## CIDR æ™ºèƒ½åˆå¹¶

é¡¹ç›®è‡ªåŠ¨å°†æ‰«æç»“æœä¸­çš„å°ç½‘æ®µåˆå¹¶æˆå¤§ç½‘æ®µï¼Œå¤§å¹…æå‡å¯è¯»æ€§ï¼š

### åˆå¹¶ç®—æ³•
1. **æ ‡å‡†åˆå¹¶**ï¼šä½¿ç”¨ `ipaddress.collapse_addresses()` åˆå¹¶é‡å å’Œç›¸é‚»ç½‘æ®µ
2. **è¶…ç½‘åˆå¹¶**ï¼šé€’å½’å°è¯•å°†ç›¸é‚»çš„åŒç­‰çº§ç½‘æ®µåˆå¹¶ä¸ºæ›´å¤§çš„è¶…ç½‘
3. **æœ€ä¼˜åŒ–**ï¼šåœ¨ä¿æŒIPè¦†ç›–èŒƒå›´çš„å‰æä¸‹ï¼Œæœ€å°åŒ–CIDRæ•°é‡

### åˆå¹¶æ•ˆæœç¤ºä¾‹
```
åˆå¹¶å‰ï¼ˆ8ä¸ª /24ï¼‰:          åˆå¹¶åï¼ˆ1ä¸ª /21ï¼‰:
111.11.0.0/24              111.11.0.0/21
111.11.1.0/24                 â†“
111.11.2.0/24              è¦†ç›–ç›¸åŒçš„2048ä¸ªIP
111.11.3.0/24              ä½†åªéœ€è¦1è¡Œï¼
111.11.4.0/24
111.11.5.0/24
111.11.6.0/24
111.11.7.0/24
```

### å®é™…æ•°æ®
åŸºäºæ²³åŒ—ç§»åŠ¨å®é™…æ‰«ææ•°æ®ï¼š
- **åŸå§‹ç½‘æ®µ**ï¼š771 ä¸ªï¼ˆåŒ…å«å¤§é‡ /24 å°æ®µï¼‰
- **åˆå¹¶å**ï¼š33 ä¸ªï¼ˆå‡å°‘ 95.7%ï¼‰
- **è¦†ç›–IP**ï¼šä¿æŒè¦†ç›–èŒƒå›´
- **æœ€å¤§ç½‘æ®µ**ï¼š183.196.0.0/14ï¼ˆ26ä¸‡+ IPï¼‰

## æŠ€æœ¯æ¶æ„

### ip2region v3.x
- **ç‰ˆæœ¬å…¼å®¹**ï¼šæ”¯æŒ IPv4 å’Œ IPv6
- **ä¸‰çº§ç¼“å­˜**ï¼šfile / vectorIndex / content
- **æŸ¥è¯¢æ€§èƒ½**ï¼švectorIndex æ¨¡å¼ä¸‹ ~10Î¼s/æ¬¡
- **æ•°æ®æ ¼å¼**ï¼šå›½å®¶|çœä»½|åŸå¸‚|ISPï¼ˆå¦‚ï¼šä¸­å›½|æ²³åŒ—çœ|çŸ³å®¶åº„å¸‚|ç§»åŠ¨ï¼‰

### RIPEstat API
- **ç«¯ç‚¹**ï¼š`https://stat.ripe.net/data/announced-prefixes/data.json`
- **è®¤è¯**ï¼šæ— éœ€è®¤è¯ï¼Œå…¬å¼€è®¿é—®
- **é™åˆ¶**ï¼šå»ºè®®å¹¶å‘ â‰¤20ï¼Œåˆç†ä½¿ç”¨
- **è¿”å›**ï¼šJSON æ ¼å¼ï¼ŒåŒ…å« IPv4/IPv6 å‰ç¼€åˆ—è¡¨

### é‡‡æ ·ç®—æ³•
```python
# å¯¹æ¯ä¸ª CIDR éšæœºé‡‡æ · n ä¸ª IP
samples = random_sample(cidr, n=3)

# æŸ¥è¯¢æ¯ä¸ª IP çš„åœ°ç†ä½ç½®
for ip in samples:
    region = ip2region.search(ip)  # æ ¼å¼: å›½å®¶|çœä»½|åŸå¸‚|ISP
    
# æ ¹æ®å‘½ä¸­ç‡åˆ†å±‚
if hits == samples: status = 'high'      # 100% å‘½ä¸­
elif hits > 0:      status = 'medium'    # éƒ¨åˆ†å‘½ä¸­
else:               status = 'none'      # æœªå‘½ä¸­
```

## è‡ªå®šä¹‰ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šè¯†åˆ«å…¶ä»–çœä»½
ä¿®æ”¹ `src/ip2region_client.py` ä¸­çš„åˆ¤æ–­é€»è¾‘ï¼š
```python
def is_target_region(self, ip, province='æ²³åŒ—', isp='ç§»åŠ¨'):
    region = self.search(ip)
    parts = region.split('|')
    return province in parts[1] and isp in parts[3]
```

### åœºæ™¯ 2ï¼šè‡ªå®šä¹‰ ASN åˆ—è¡¨
ç¼–è¾‘ `data/cmcc.txt`ï¼Œæ·»åŠ æˆ–åˆ é™¤ ASNï¼š
```
9808,56048,24400,56040,56046,...
```

### åœºæ™¯ 3ï¼šè°ƒæ•´é‡‡æ ·ç­–ç•¥
```bash
# é«˜ç²¾åº¦æ‰«æï¼ˆé‡‡æ · 10 ä¸ª IPï¼‰
python3 src/main.py --sample 10

# å¿«é€Ÿæ‰«æï¼ˆé‡‡æ · 1 ä¸ª IPï¼‰
python3 src/main.py --sample 1
```

## ä¾èµ–è¯´æ˜

```txt
aiohttp>=3.8.0      # å¼‚æ­¥ HTTP å®¢æˆ·ç«¯
tqdm>=4.65.0        # è¿›åº¦æ¡æ˜¾ç¤º
requests>=2.28.0    # HTTP è¯·æ±‚åº“
```

Python ç‰ˆæœ¬è¦æ±‚ï¼š`>= 3.8`

## æ€§èƒ½æŒ‡æ ‡

åŸºäºé»˜è®¤é…ç½®ï¼ˆ26 ä¸ª ASNï¼Œ~27,000 ä¸ª CIDRï¼Œé‡‡æ · 3 æ¬¡ï¼‰ï¼š

- **ASN å‰ç¼€è·å–**ï¼š~30 ç§’ï¼ˆé¦–æ¬¡ï¼Œå« API è¯·æ±‚ï¼‰
- **CIDR æ‰«æ**ï¼š~20 ç§’ï¼ˆ24 çº¿ç¨‹ï¼Œ~1,350 CIDR/ç§’ï¼‰
- **æ€»è€—æ—¶**ï¼š~50 ç§’ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰
- **ç¼“å­˜åŠ é€Ÿ**ï¼š~20 ç§’ï¼ˆä½¿ç”¨ --use-cacheï¼‰

## å¸¸è§é—®é¢˜

### Q1: ip2region_v4.xdb ä¸‹è½½å¤±è´¥ï¼Ÿ
**A**: æ‰‹åŠ¨ä¸‹è½½åæ”¾åˆ° `data/` ç›®å½•ï¼š
```bash
curl -L -o data/ip2region_v4.xdb \
  https://raw.githubusercontent.com/lionsoul2014/ip2region/master/data/ip2region_v4.xdb
```

### Q2: RIPEstat API è¯·æ±‚å¤±è´¥ï¼Ÿ
**A**: æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œæˆ–é™ä½å¹¶å‘æ•°ï¼š
```bash
python3 src/main.py --fetch-concurrency 5
```

### Q3: å¦‚ä½•æ›´æ–° ip2region æ•°æ®åº“ï¼Ÿ
**A**: åˆ é™¤æ—§æ–‡ä»¶åé‡æ–°è¿è¡Œï¼š
```bash
rm data/ip2region_v4.xdb
python3 src/main.py
```

### Q4: è¾“å‡ºç»“æœä¸ºç©ºï¼Ÿ
**A**: æ£€æŸ¥ ASN åˆ—è¡¨æ˜¯å¦æ­£ç¡®ï¼Œæˆ–æŸ¥çœ‹ `prefixes_cache.json` æ˜¯å¦æœ‰æ•°æ®ã€‚

## å‚è€ƒèµ„æ–™

- [ip2region å®˜æ–¹ä»“åº“](https://github.com/lionsoul2014/ip2region)
- [RIPEstat API æ–‡æ¡£](https://stat.ripe.net/docs/data_api)
- [ip2region Python Binding](https://github.com/lionsoul2014/ip2region/tree/master/binding/python)

## è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ª [LICENSE](LICENSE) æ–‡ä»¶ä¸­çš„è®¸å¯åè®®ã€‚

---

<!-- STATS_START -->

## æŒ‰çœä»½ç»Ÿè®¡ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰

| çœä»½ | å‘½ä¸­ IP æ®µæ•° |
|------|------------:|
| æ²³åŒ— | 755 |
| å››å· | 3 |
| å®‰å¾½ | 1 |
| æ¹–å— | 1 |

<!-- STATS_END -->
